#include"MiddleBoss.h"
#include"Operators.h"
#include"StraightBullet.h"
//****************************************************************
// 
// 中型のボスのステートマシンを定義する 
// 
//****************************************************************


void MiddleBoss::fStartInit()
{
    // ボス登場時のイベントシーン（未実装）
}

void MiddleBoss::fStartUpdate(float elapsedTime_, GraphicsPipeline& Graphics_)
{
    // ボス登場時のイベントシーン（未実装）
}

void MiddleBoss::fTourInit()
{
    // ステージの周囲を周回する動き
    mPosition = { 0.0f,150.0f,150.0f };

}

void MiddleBoss::fTourUpdate(float elapsedTime_, GraphicsPipeline& Graphics_)
{
    // ステージの原点を中心にぐるぐる回る
    mLuaWorld.fSetFunction("fTourMove");
    mLuaWorld.fSetNumeric(elapsedTime_);
    mLuaWorld.fCallFunc(1, 2);

    // 値をLuaから受け取り
    mPosition.x = static_cast<float>(mLuaWorld.fGetDouble(-1));
    mPosition.z = static_cast<float>(mLuaWorld.fGetDouble(-2));

    // 各攻撃に遷移するときの条件
    // ５秒ごとに抽選
    if(static_cast<int>(mTimer)%5==0)
    {
        const int selectedNum = rand() % 4;
        if(selectedNum==0)
        {
            fChangeState(State::TourBeamReady);
        }
        else if(selectedNum<=2)
        {
            fChangeState(State::TourShot);
        }

    }


}

//--------------------<ビームの準備>--------------------//
void MiddleBoss::fTourLaserReadyInit()
{
    // 照準を初期化
    mLaserBeamLength = 0.0f;
    mLaserShotTimer = 0.0f;
    mLuaWorld.fSetFunction("fTourLaserReadyInit");
    mLuaWorld.fCallFunc(0, 1);
}
void MiddleBoss::fTourLaserReadyUpdate(float elapsedTime_, GraphicsPipeline& Graphics_)
{
    mLuaWorld.fDestroyStack();
    mLuaWorld.fSetFunction("fTourLaserReady");
    mLuaWorld.fSetNumeric(elapsedTime_);
    mLuaWorld.fCallFunc(1, 3);

    //mLuaWorld.fDebugShowStack();
    // ポインターの透明度を更新
    mLaserPointer.fSetAlpha(mLuaWorld.fGetDouble(-2));
    // ポインターの長さを更新
    mLaserPointer.fSetLengthThreshold(mLuaWorld.fGetDouble(-1));

    // 条件を満たしていたらステートを変更
    if (mLuaWorld.fGetBool(-3))
    {
        fChangeState(State::TourBeam);
        mLaserPointer.fSetLengthThreshold(0.0f);
    }
}
//--------------------<ビーム発射>--------------------//
void MiddleBoss::fTourLaserInit()
{
    mLaserPointerLength = 0.0f;
    mLaserBeamLength = 0.0f;
    mLaserShotTimer = 0.0f;
    mBeamRadius = 3.0f;
    // 終点を計算
    auto endPoint = mPlayerPosition;
    endPoint.y += 1.5f;

    // ベクトルを算出
    DirectX::XMFLOAT3 v = endPoint - mPosition;
    v = Math::Normalize(v);
    endPoint = mPosition + (v * 500.0f);
    
    mLaserBeam.fSetPosition(mPosition, endPoint);
}
void MiddleBoss::fTourLaserUpdate(float elapsedTime_, GraphicsPipeline& Graphic_)
{
    // ビームを伸ばす
    if (mLaserBeamLength < 1.0f)
    {
        mLaserBeamLength += (elapsedTime_ * 5.0f);
    }
    else // 最大なら固定
    {
        mLaserBeamLength = 1.0f;
    }
    

    mLaserShotTimer += elapsedTime_;
    if(mLaserShotTimer>=5.0f)
    {
        fChangeState(State::Tour);
    }
    else if(mLaserShotTimer>=3.0f)
    {
        if (mBeamRadius > 0.0f)
        {
            mBeamRadius -= (elapsedTime_ * 10.0f);
        }
        else
        {
            mBeamRadius = 0.0f;
        }
    }
}

//--------------------<単発射撃>--------------------//
void MiddleBoss::fTourShotInit()
{
    // 初期化
}
void MiddleBoss::fTourShotUpdate(float elapsedTime_, GraphicsPipeline& Graphics_)
{
    // 射撃方向を算出
    auto v = mPlayerPosition - mPosition;
    v = Math::Normalize(v);
    //v* TourBulletSpeed;
    mfAddFunc(new StraightBullet(Graphics_, mPosition, v));
    fChangeState(State::Tour);

}
